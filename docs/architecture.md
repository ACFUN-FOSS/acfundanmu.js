# 架构设计文档

## 系统概述

AcFun 直播 HTTP API 是一个将复杂的 WebSocket 弹幕协议转换为简单易用的 HTTP API 的封装库。采用分层模块化架构，提供 SDK 和服务器两种使用模式。

## 核心设计理念

### 协议转换
将 AcFun 原始的 WebSocket + Protobuf 协议转换为:
- 简单的 HTTP RESTful API
- 事件驱动的回调机制
- 类型安全的 TypeScript 接口

### 分层架构
- **应用层**: SDK模式 / HTTP服务器模式
- **服务层**: 各业务服务（Auth、Danmu、Live、User等）
- **核心层**: HTTP客户端、协议工具、事件解析器
- **外部接口**: AcFun API 服务器、WebSocket 服务器

### 模块化设计
每个服务模块独立封装，职责清晰：
- `AuthService`: 认证服务
- `DanmuService`: 弹幕服务  
- `LiveService`: 直播服务
- `UserService`: 用户服务
- `GiftService`: 礼物服务
- `ManagerService`: 房管服务
- `LivePreviewService`: 直播预告服务
- `ReplayService`: 直播回放服务
- `BadgeService`: 守护徽章服务

## 技术架构

### 核心组件

#### HttpClient
封装 Axios 实现的 HTTP 客户端：
- 统一的请求拦截
- 响应格式转换
- 错误处理
- Token 管理

#### EventParser  
弹幕事件解析器：
- Protobuf 消息解码
- 事件类型识别
- 数据结构转换

#### ProtoUtils
Protobuf 工具：
- 消息编码/解码
- AES 加密/解密
- Gzip 压缩/解压

### 弹幕服务架构

弹幕服务是最复杂的模块，包含完整的连接管理机制：

#### 连接生命周期
1. **初始化**: 获取直播信息、创建会话
2. **连接**: 建立 WebSocket 连接
3. **注册**: 发送注册请求，获取 instanceID 和 sessionKey
4. **进房**: 发送进房请求
5. **激活**: 开始接收弹幕，启动心跳
6. **断开**: 关闭连接，清理资源

#### 管理器组件

**ReconnectManager** - 重连管理器
- 自动重连机制
- 指数退避策略
- 重连状态跟踪

**HeartbeatManager** - 心跳管理器
- 定时心跳发送
- 心跳响应监控
- 自适应心跳间隔

**HealthCheckManager** - 健康检查管理器
- 实时健康监控
- 性能指标统计
- 健康评分计算

**SessionManager** - 会话管理器
- 会话创建/销毁
- 状态管理
- 批量操作

## 数据流

### 认证流程
```
用户 -> 获取二维码 -> 扫码 -> 轮询状态 -> 获取Token -> 设置Token
```

### 弹幕流程
```
启动 -> 获取liveID -> WebSocket连接 -> 注册 -> 进房 -> 接收弹幕
     ↓
    回调函数处理事件
```

### 直播流程
```
检查权限 -> 获取推流地址 -> 配置OBS -> 推流 -> 检测推流 -> 开播
```

### 房管管理流程
```
获取房管列表 -> 添加/删除房管 -> 房管踢人 -> 主播踢人 -> 查看踢人记录
```

### 直播预告流程
```
获取预告列表 -> 查看预告详情 -> 设置提醒
```

### 直播回放流程
```
获取回放信息 -> 获取播放地址 -> 播放回放
```

## 设计模式

### 工厂模式
`AcFunLiveApi` 类作为工厂，统一创建和管理各个服务实例。

### 观察者模式
弹幕服务使用回调函数实现事件通知机制。

### 策略模式
重连机制支持多种退避策略。

### 单例模式
每个服务实例在 API 对象中保持单例。

## 性能优化

### 连接复用
- 保持 WebSocket 长连接
- 避免频繁创建/销毁连接

### 心跳优化
- 自适应心跳间隔
- 减少不必要的网络开销

### 批量操作
- 支持批量暂停/恢复会话
- 提高操作效率

### 资源管理
- 及时清理空闲会话
- 自动清理错误会话
- 防止内存泄漏

## 可靠性设计

### 错误处理
- 统一的错误响应格式
- 详细的错误码定义
- 错误日志记录

### 超时控制
- WebSocket 连接超时（10秒）
- 注册超时（5秒）
- 心跳超时（30秒）

### 健康检查
- 连接状态监控
- 心跳成功率统计
- 综合健康评分

### 自动恢复
- 连接断开自动重连
- 重连失败后优雅降级
- 保存会话状态用于恢复

## 扩展性

### 服务扩展
添加新服务只需:
1. 创建 Service 类
2. 在 AcFunLiveApi 中注册
3. 导出类型定义

新增的服务示例：
- `LivePreviewService`: 提供直播预告功能
- `ReplayService`: 提供直播回放功能  
- `BadgeService`: 提供守护徽章管理功能

### 事件扩展
添加新的弹幕事件类型:
1. 在 types 中定义接口
2. 在 EventParser 中添加解析逻辑
3. 更新回调函数类型

### 协议升级
支持协议版本升级:
- Protobuf 定义更新
- 向后兼容处理
- 版本协商机制

## 安全性

### Token 保护
- Token 加密存储
- 不在日志中输出敏感信息
- 支持 Token 刷新

### 连接安全
- 使用 WSS 加密连接
- 消息体 AES 加密
- 防止中间人攻击

### 权限验证
- 接口级权限检查
- 操作级权限验证
- 防止越权访问

详细的数据模型请参阅 [数据模型文档](./data-models.md)。
