# 直播管理系统架构设计

本文档旨在详细阐述基于 Electron 和 AcFun-Live-API 构建的主播直播管理系统的架构设计，确保系统具备高可扩展性、稳定性和高性能。

## 1. 系统概述

该系统是一个专为 AcFun 主播设计的桌面端应用程序，旨在提供一个集成化的直播控制、监控和管理平台。它通过整合现有的 `acfunlive-backend` API 能力，为用户提供无缝的直播体验，并通过插件机制满足个性化需求。

### 1.1. 设计原则

- **模块化**: 将系统划分为独立的、可重用的模块，降低耦合度。
- **可扩展性**: 设计灵活的插件系统，允许第三方开发者扩展功能。
- **稳定性**: 核心功能与插件环境隔离，确保插件的崩溃不会影响主应用。
- **用户体验**: 采用现代化的 UI/UX 设计，提供直观、高效的操作界面。

### 1.2. 技术选型

- **桌面端框架**: Electron (v28+)
- **UI 框架**: React (v18+) with TypeScript
- **状态管理**: Redux Toolkit
- **核心 API**: 复用 `acfunlive-backend` Node.js 库
- **通信**:
    - **进程间**: Electron IPC (Inter-Process Communication)
    - **实时数据**: WebSocket
    - **本地服务**: Express.js (集成在主进程中)
- **打包工具**: Electron Forge / Webpack

## 2. 模块划分

系统主要分为以下几个核心模块：

![模块划分图](https://p.pstatp.com/origin/tos-cn-i-589rglk23g/1704966779637219355)

### 2.1. 主进程 (Main Process)

主进程是应用程序的入口点，负责管理整个应用的生命周期。

- **窗口管理**: 创建和管理浏览器窗口 (`BrowserWindow`)。
- **应用生命周期**: 处理应用的启动、关闭、激活等事件。
- **IPC 通信**: 作为 IPC 的中心枢纽，负责在渲染进程和后端服务之间传递消息。
- **服务层集成**: 初始化并管理 `AcFunLiveApi` 的所有服务实例（如 `LiveService`, `DanmuService` 等）。
- **插件管理器**: 负责插件的加载、生命周期管理、权限控制和沙箱执行。
- **本地 HTTP 服务器**: 启动一个本地 Express 服务器，用于处理来自插件或外部工具的 HTTP 请求。

### 2.2. 渲染进程 (Renderer Process)

每个 `BrowserWindow` 实例都运行一个独立的渲染进程，负责展示用户界面。

- **UI 渲染**: 使用 React 构建用户界面，包括仪表盘、直播控制面板、弹幕池等。
- **状态管理**: 使用 Redux 维护 UI 状态，与主进程同步数据。
- **用户交互**: 响应用户的操作，并通过 IPC 将请求发送到主进程。
- **插件 UI 挂载**: 提供预定义的 UI 插槽（Slots），供插件渲染自定义内容。

### 2.3. 服务层 (Service Layer)

服务层直接复用 `acfunlive-backend` 的能力，作为连接 AcFun 服务器和本地应用的核心。

- **API 封装**: 将 `AcFunLiveApi` 的方法封装成更易于主进程调用的接口。
- **认证管理**: 处理用户登录、Token 获取与刷新。
- **直播服务**: 调用 `LiveService` 实现开始/结束直播、修改封面、获取 OBS 配置等功能。
- **弹幕服务**: 通过 `DanmuService` 连接弹幕服务器，接收并解析实时弹幕、礼物、点赞等事件。
- **管理服务**: 调用 `ManagerService` 实现房管操作和用户管理。
- **事件总线**: 创建一个内部事件总线，用于分发来自 `DanmuService` 的实时事件，供主进程和插件订阅。

### 2.4. 插件系统 (Plugin System)

插件系统是该架构的核心扩展机制。

- **插件加载器**: 在主进程中动态加载插件代码。
- **沙箱环境**: 每个插件运行在独立的 Node.js `vm` 上下文中，限制其对系统资源的访问。
- **权限管理**: 基于插件 `manifest.json` 中声明的权限，控制其可调用的 API。
- **事件订阅**: 插件可以通过统一的事件总线订阅核心事件（如弹幕、礼物）。
- **UI 注入**: 插件可以在指定的 UI 插槽中渲染自定义的 React 组件。

## 3. 界面设计 (UI/UX)

- **设计风格**: 采用**Glassmorphism Tech Blue UI**风格，以科技蓝和青色为主色调，搭配深色背景和半透明的玻璃质感卡片，营造现代、轻盈的视觉感受。
- **布局**:
    - **顶部导航**: 显示 Logo、直播间信息、全局状态和快捷操作。
    - **侧边栏**: 功能模块导航，如仪表盘、直播控制、插件中心等。
    - **主内容区**: 卡片化布局，展示核心信息和操作面板。
    - **底部状态栏**: 显示网络延迟、心跳状态、错误信息等。
- **核心页面**:
    1.  **仪表盘**: 概览直播状态、实时事件流、系统告警。
    2.  **直播控制**: 提供开始/结束直播、更换封面、编辑标题、预览画面等功能。
    3.  **聊天与管理**: 展示弹幕列表、礼物墙，并提供房管操作面板。
    4.  **回放中心**: 管理历史直播回放，支持预览和导出。
    5.  **插件与设置**: 管理插件的安装与启停，并进行全局应用设置。

## 4. 总结

该架构通过明确的模块划分和清晰的职责定义，构建了一个稳定且可扩展的直播管理系统。Electron 与现有 Node.js API 库的结合，最大化地复用了后端能力，同时通过灵活的插件机制，为未来的功能扩展提供了无限可能。
